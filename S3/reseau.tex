\documentclass[10pt,a4paper,french]{article}
\usepackage{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{../latex/clovisai}

\usepackage{pgf-umlsd}

\begin{document}

\title{Réseau}
\author{Ivan Canet}
\maketitle

\begin{abstract}
Ceci est l'introduction du document.
\end{abstract}
\tableofcontents

\section{Configuration réseau via IP}

\subsection{Adresse IP}

Une adresse IPv4 est constituée de 32 bits, elle est utilisée pour communiquer entre machines sur le réseau.

Dans un réseau local, on ``bloque'' le début de l'adresse et on utilise que la fin, par exemple l'adresse de réseau `221.164.0.0/24' bloque les 24 premiers bits, ce qui veut dire que les adresses de ce réseau vont de `221.164.0.1' à `221.164.0.254'.

Dans un réseau, l'adresse finissant par un 0 est l'adresse du réseau (l'adresse de la box/routeur) et l'adresse finissant par 255 est l'adresse de broadcast, qui permet d'envoyer un paquet à tout le monde.

Le réseau `127.0.0.0/8' est un faux réseau qui revient sur soi-même, il est pratique pour tester les applications en réseau, etc. Toutes les adresses commençant par 127 ne partent donc pas sur le réseau, souvent on utilise `127.0.0.1'.

Chaque machine peut se connecter à plusieurs `interfaces' : elles correspondent aux différentes prises sur la carte réseau. Par exemple, la première prise ethernet est nommée `eth0', puis `eth1', etc.

\subsection{Commandes utiles}

On utilise {\tt dev} pour ``device''.

\paragraph{Afficher adresses IP et interfaces}

\begin{minted}{bash}
ip a
ifconfig
\end{minted}

\paragraph{Afficher les interfaces activées}

\begin{minted}{bash}
ip link ls up
\end{minted}

\paragraph{Assigner une adresse IP et un masque à une interface}

\begin{minted}{bash}
ip a add 192.168.74.101/24 dev eth0
ifconfig eth0 192.168.74.101 netmask 255.255.255.0
\end{minted}

\paragraph{Activer le mode routeur}

\begin{minted}{bash}
sysctl -w net.ipv4.ip\_forward=1
\end{minted}

\paragraph{Voir la table de routage}

\begin{minted}{bash}
ip r
\end{minted}

\paragraph{Ajouter une route par défaut}

\begin{minted}{bash}
ip r add default via 192.168.74.254
route add -net default gw 192.168.74.254
\end{minted}

\paragraph{Ajouter une route}

\begin{minted}{bash}
ip r add 22.33.44.0/24 via 11.22.33.55
route add -net 22.33.44.0 netmask 255.255.255.0 gw 11.22.33.55
\end{minted}

\paragraph{Activer/Désactiver une interface}

\begin{minted}{bash}
ip link set dev eth0 up|down
ifup|ifdown eth0
\end{minted}

\subsection{Configurer de manière pérenne}

Il faut modifier le fichier {\tt etc/network/interfaces}.

\subsubsection{Pour un client}

\begin{minted}{bash}
auto eth0
iface eth0 inet static
	address 10.1.1.22                    # IP de la machine
	netmask 255.255.255.0                # Masque de sous-réseau
	gateway 10.1.1.254                   # Route par défaut
\end{minted}

\subsubsection{Pour un routeur}

\begin{minted}{bash}
auto eth0
iface eth0 inet static
	address 10.1.1.254                   # IP de la machine
	netmask 255.255.255.0                # Masque de sous-réseau
	up sysctl -w net.ipv4.ip_forward=1   # Activer le port forwarding
\end{minted}

On utilise {\tt up} pour lancer une commande au démarrage de l'interface (ici, l'activation du port forwarding, mais on peut mettre n'importe quelle commande).

\section{Configuration réseau via DHCP}

\subsection{Protocole DHCP}

Le protocole DHCP permet de reléguer la configuration. Au lieu d'enregistrer la configuration dans le client, on va créer un serveur DHCP et le client va lui demander son IP.

\subsubsection{Trames}

\paragraph{Initialisation}

Le client demande en broadcast une adresse IP au serveur, le serveur lui en propose une, le client dit qu'il l'accepte (toujours en broadcast), et enfin le serveur confirme.

Ces étapes sont importantes dans le cas où il y a plusieurs serveurs DHCP : le client ``choisit'' quelle offre il souhaite, et on évite qu'un client ai 2 IPs.

\begin{center}
\begin{sequencediagram}
	\newthread{client}{Client}
	\newthread{server}{Serveur DHCP}
	
	\mess[1]{client}{DISCOVER}{server}
	\mess[1]{server}{OFFER}{client}
	\mess[1]{client}{REQUEST}{server}
	\mess[1]{server}{ACK}{client}
\end{sequencediagram}
\end{center}

\paragraph{Libération}

Le client peut annoncer qu'il quitte le réseau, son adresse IP est alors libérée. Ce n'est absolument pas obligatoire, c'est plus de la politesse.

\begin{center}
\begin{sequencediagram}
	\newthread{client}{Client}
	\newthread{server}{Serveur DHCP}
	
	\mess[1]{client}{RELEASE}{server}
\end{sequencediagram}
\end{center}

\paragraph{Renouvellement à mi-bail}

À la moitié du bail, le client fait une demande de renouvellement. Cette fois, la demande est faite en direct au serveur, pas en broadcast.

\begin{center}
\begin{sequencediagram}
	\newthread{client}{Client}
	\newthread{server}{Serveur DHCP}
	
	\mess[1]{client}{REQUEST}{server}
	\mess[1]{server}{ACK}{client}
\end{sequencediagram}
\end{center}

\paragraph{Renouvellement en fin de bail}

Si le serveur n'a pas répondu lors du mi-bail, le client fait une nouvelle demande en broadcast à 87.5\% du bail (elle fait une demande à tous les serveurs DHCP, pour le cas où le précédent a un problème).

\begin{center}
\begin{sequencediagram}
	\newthread{client}{Client}
	\newthread{server}{Serveur DHCP}
	
	\mess[1]{client}{REQUEST}{server}
	\mess[1]{server}{ACK}{client}
\end{sequencediagram}
\end{center}

\subsubsection{Messages du protocole}

\paragraph{Envoyés par le client}

\begin{description}
\item[DISCOVER] Qui sont les serveurs DHCP disponibles ?
\item[REQUEST] Est-ce que je peux avoir un bail ?
\item[DECLINE] Cette adresse ne me plaît pas.
\item[RELEASE] Je n'ai plus besoin de l'adresse, tu peux la réutiliser.
\item[INFORM] Je veux plus d'informations sur le réseau (liste des imprimantes...)
\end{description}

\paragraph{Envoyés par le serveur}

\begin{description}
\item[OFFER] Voilà une IP, est-ce que tu la veux?
\item[ACK] C'est bon, le bail est validé.
\item[NACK] Je refuse de donner un bail.
\end{description}

\subsection{Configuration}

\subsubsection{Côté client}

L'énorme avantage d'utiliser DHCP et que la configuration côté client est très faible.

On modifie le fichier {\tt /etc/network/interfaces}:

\begin{minted}{bash}
auto eth0
iface eth0 inet dhcp
\end{minted}

La liste des baux accordés est disponible dans {\tt /var/lib/dhcp/dhclient.eth0.leases} (remplacer {\tt eth0} par la bonne interface).

\subsubsection{Côté serveur}

On modifier le fichier {\tt /etc/dhcp/dhcpd.conf}:

\begin{minted}{bash}
# Temps par défaut pour les baux, en secondes
default-lease-time 600;
# Durée maximale d'un bail, en secondes
max-lease-time 7200;

# Le serveur DHCP a pour IP 192.168.10.0/24
subnet 192.168.10.0 netmask 255.255.255.0 {
  # Les clients auront une IP comprise entre 192.168.10.100 et 192.168.10.150
  # À noter que le serveur DHCP lui-même ne doit pas être dans cette range!
  range 192.168.10.100 192.168.10.150;
  # On dit que la machine a0:00:01:02:03:04 a une adresse IP réservée : 192.168.10.200
  # On nomme la machine `server' ; le nom n'a pas d'importance
  # À noter que l'IP réservée N'EST PAS dans la range précisée plus haut!
  host server {
    hardware-ethernet a0:00:01:02:03:04;
    fixed-address 192.168.10.200;
  }
  # Les clients utiliseront le routeur 192.168.10.1 comme route par défaut (gateway)
  option routers 192.168.10.1;
}
\end{minted}

La liste des baux est dans {\tt /var/lib/dhcp/dhcpd.leases}.

\end{document}
